<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Coord</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="./style.css" />
    <script src="../size.js"></script>
    <script src="./proxy.js"></script>
    <script src="../minivue.js"></script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div id="data">
      <button id="reset">重置</button>
      <h3>偏移量</h3>
      <div>offsetX = translateX: {{translate[0]}}</div>
      <div>offsetY = translateY: {{translate[1]}}</div>
      <h3>缩放值</h3>
      <div>scale: {{scale}}</div>
    </div>

    <script>
      let { $data } = new MiniVue("#data")
      let button = document.getElementById("reset")
      button.addEventListener("click", () => {
        reset()
      })

      let { canvas, width: canvasWidth, height: canvasHeight } = new KSize(
        "canvas"
      )
      canvas.style.cursor = "grabbing"
      const rect = canvas.getBoundingClientRect()
      const canvasLeft = rect.left
      const canvasTop = rect.top
      let ctx = canvas.getContext("2d")
      canvas.addEventListener("mousedown", processMousedown)
      canvas.addEventListener("mousewheel", processMouseWheel)
      window.addEventListener("mouseup", processMouseup)

      let last_mouse = [0, 0]
      let translate = MiniVue.proxy("translate", [0, 0])

      function reset() {
        translate[0] = 0
        translate[1] = 0
        draw()
      }

      function processMousedown(e) {
        adjustMouseEvent(e)
        last_mouse[0] = e.localX
        last_mouse[1] = e.localY
        canvas.addEventListener("mousemove", processMousemove)
      }

      function processMousemove(e) {
        adjustMouseEvent(e)
        let cur_mouse = [e.localX, e.localY]
        let delta = [cur_mouse[0] - last_mouse[0], cur_mouse[1] - last_mouse[1]]
        last_mouse[0] = cur_mouse[0]
        last_mouse[1] = cur_mouse[1]
        translate[0] += delta[0]
        translate[1] += delta[1]
        draw()
      }

      function processMouseup() {
        canvas.removeEventListener("mousemove", processMousemove)
      }

      let scale = MiniVue.proxy("scale", 1)
      function processMouseWheel(e) {
        e.preventDefault()
        if (e.wheelDelta > 0) {
          scale.value *= 1.1
        } else {
          scale.value *= 1 / 1.1
        }
      }

      function adjustMouseEvent(e) {
        e.localX = e.clientX - canvasLeft
        e.localY = e.clientY - canvasTop
      }

      draw()

      function draw() {
        ctx.clearRect(0, 0, canvasWidth, canvasHeight)
        ctx.save()
        ctx.translate(translate[0], translate[1])
        drawCoord()
        ctx.restore()
      }

      function drawCoord() {
        let lineWidth = 1
        let centerHeight = canvasHeight / 2 - lineWidth
        let centerWidth = canvasWidth / 2 - lineWidth
        let step = 50
        let fontSize = 14
        // x轴
        // -translate[0] 无限长
        ctx.beginPath()
        ctx.moveTo(0 - translate[0], centerHeight)
        ctx.lineTo(canvasWidth - translate[0], centerHeight)
        ctx.lineWidth = lineWidth
        ctx.stroke()
        // 坐标
        // -translate[0] 无限步数
        let countPX = (centerWidth - translate[0]) / step
        for (let i = 0; i < countPX; i++) {
          const x = i * step + centerWidth
          ctx.beginPath()

          ctx.moveTo(x, centerHeight)
          ctx.lineTo(x, centerHeight - 10)

          ctx.font = fontSize + "px Georgia"
          ctx.fillText(i * step, x - fontSize, centerHeight + fontSize)
          ctx.stroke()
        }
        let countNX = (centerWidth + translate[0]) / step
        for (let i = 0; i < countNX; i++) {
          const x = i * -step + centerWidth
          ctx.beginPath()

          ctx.moveTo(x, centerHeight)
          ctx.lineTo(x, centerHeight - 10)

          ctx.font = fontSize + "px Georgia"
          ctx.fillText(i * -step, x - fontSize, centerHeight + fontSize)
          ctx.stroke()
        }
        // y轴
        ctx.beginPath()
        ctx.moveTo(centerWidth, 0 - translate[1])
        ctx.lineTo(centerWidth, canvasHeight - translate[1])
        ctx.lineWidth = lineWidth
        ctx.stroke()
        // 坐标
        let countPY = (centerHeight + translate[1]) / step
        for (let i = 0; i < countPY; i++) {
          const y = i * -step + centerHeight
          ctx.beginPath()
          ctx.moveTo(centerWidth, y)
          ctx.lineTo(centerWidth + 10, y)

          ctx.font = fontSize + "px Georgia"
          ctx.fillText(i * step, centerWidth + 12, y + 3)

          ctx.stroke()
        }
        let countNY = (centerHeight - translate[1]) / step
        for (let i = 0; i < countNY; i++) {
          const y = i * step + centerHeight
          ctx.beginPath()
          ctx.moveTo(centerWidth, y)
          ctx.font = fontSize + "px Georgia"
          ctx.fillText(i * -step, centerWidth + 12, y + 3)
          ctx.lineTo(centerWidth + 10, y)
          ctx.stroke()
        }
      }
    </script>
  </body>
</html>
